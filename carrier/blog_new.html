<div id="carrier-blog-wrapper">
    <style>
      <?php include_once get_stylesheet_directory() . '/carrier-articles-style.css'; ?>
    </style>

    <div class="division">
      <h2 class="title">أحدث المقالات</h2>
      <div id="loader" class="loader">جاري التحميل...</div>
      <div class="articles" style="display: none;" id="articles">
        <div class="main-article" id="main-article"></div>
        <div class="side-articles" id="side-articles"></div>
      </div>
    </div>

    <div class="posts-division">
      <h2 class="posts-title">أقسام المقالات</h2>
      <div class="posts-filters" id="categoryFilters"></div>
      <div class="posts-articles" style="display:none;" id="category-articles"></div>
      <div id="loader22" class="loader22">جاري التحميل...</div>
      <div class="post-load-more" onclick="loadMore()" id="loadMoreBtn">عرض المزيد <i class="fa-solid fa-chevron-down"></i></div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
      const apiUrl = 'https://carrier-eg.com/wp-json/wp/v2/posts?_embed&lang=ar&per_page=6';
      const categoriesUrl = 'https://carrier-eg.com/wp-json/wp/v2/categories?_embed&lang=ar';
      let page = 1;
      let selectedCategoryId = null;

      function formatDateTime(date) {
        const d = new Date(date);
        return {
          dateString: d.toLocaleDateString('en-GB').replace(/\//g, ' - '),
          timeString: d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })
        };
      }

      function isArabicPost(posts) {
        if (!Array.isArray(posts)) return [];
        return posts.filter(p => p.link.includes('/ar/') && p._embedded?.['wp:featuredmedia']);
      }

      function renderMainArticle(post) {
        const { dateString, timeString } = formatDateTime(post.date);
        const excerpt = post.excerpt.rendered.replace(/<[^>]+>/g, '').slice(0, 120);
        return `
          <a href="${post.link}" style="text-decoration: none; color: inherit;">
            <img src="${post._embedded['wp:featuredmedia'][0].source_url}" alt="${post.title.rendered}" loading="lazy">
            <small style="direction: ltr; display: inline-flex; align-items: center; gap: 6px; justify-content:end; margin-top: 10px;">
              <span>${timeString}</span><i class="fa-regular fa-clock"></i>
              <span>${dateString}</span><i class="fa-regular fa-calendar-days"></i>
            </small>
            <h3>${post.title.rendered}</h3>
            <p style="margin-top: 0; font-size: 24px; color: #7A7A7A;">
              ${excerpt}..<span class="more-link">المزيد</span>
            </p>
          </a>`;
      }

      function renderSideArticle(post) {
        const { dateString, timeString } = formatDateTime(post.date);
        const excerpt = post.excerpt.rendered.replace(/<[^>]+>/g, '').slice(0, 100);
        return `
          <a href="${post.link}" style="text-decoration: none; color: inherit;">
            <div class="side-article">
              <img src="${post._embedded['wp:featuredmedia'][0].source_url}" alt="${post.title.rendered}" loading="lazy">
              <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                  <h4>${post.title.rendered}</h4>
                  <p style="font-size: 16px; color: #7A7A7A;">${excerpt}<span class="more-link"> المزيد..</span></p>
                </div>
                <small style="direction: ltr; display: inline-flex; align-items: center; gap: 6px; justify-content:end;">
                  <span>${timeString}</span><i class="fa-regular fa-clock"></i>
                  <span>${dateString}</span><i class="fa-regular fa-calendar-days"></i>
                </small>
              </div>
            </div>
          </a>`;
      }

      function renderCard(post) {
        const { dateString, timeString } = formatDateTime(post.date);
        const excerpt = post.excerpt.rendered.replace(/<[^>]+>/g, '').slice(0, 100);
        return `
          <a href="${post.link}" class="post-card">
            <img src="${post._embedded['wp:featuredmedia'][0].source_url}" alt="${post.title.rendered}" loading="lazy">
            <div class="post-meta">
              <small style="direction: ltr; display: inline-flex; align-items: center; gap: 6px; justify-content:end;">
                <span>${timeString}</span><i class="fa-regular fa-clock"></i>
                <span>${dateString}</span><i class="fa-regular fa-calendar-days"></i>
              </small>
            </div>
            <div class="post-card-content">
              <h3>${post.title.rendered}</h3>
              <p>${excerpt}...</p>
              <span class="post-more-link">اقرأ المزيد</span>
            </div>
          </a>`;
      }

      function showarticles(posts) {
        if (!posts.length) return;
        document.getElementById('main-article').innerHTML = renderMainArticle(posts[0]);
        document.getElementById('side-articles').innerHTML = posts.slice(1, 4).map(renderSideArticle).join('');
      }

      function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
      }

      function showarticlesSection(show) {
        document.getElementById('articles').style.display = show ? 'grid' : 'none';
      }

      function loadarticles(reset = false, btn = null) {
        const categoryParam = selectedCategoryId ? `&categories=${selectedCategoryId}` : '';
        const division = document.getElementById('category-articles');
        if (reset) {
          division.innerHTML = '';
          page = 1;
          btn = document.getElementById('loadMoreBtn');
          btn.innerHTML = 'عرض المزيد <i class="fa-solid fa-chevron-down"></i>';
          btn.disabled = false;
        }

        document.getElementById('loader22').style.display = 'flex';

        fetch(`${apiUrl}&page=${page}${categoryParam}`)
          .then(r => r.json())
          .then(isArabicPost)
          .then(posts => {
            document.getElementById('loader22').style.display = 'none';
            if (!posts.length) {
              btn.innerText = 'لا توجد مقالات أخرى';
              btn.disabled = true;
              return;
            }
            division.innerHTML += posts.map(renderCard).join('');
            division.style.display = 'grid';
          })
          .catch(e => {
            document.getElementById('loader22').style.display = 'none';
            btn.innerText = 'حدث خطأ، حاول مرة أخرى';
            btn.disabled = false;
          });
      }

      function loadMore() {
        const btn = document.getElementById('loadMoreBtn');
        btn.innerHTML = 'جاري التحميل...';
        btn.disabled = true;
        page++;
        loadarticles(false, btn);
      }

      function loadCategories() {
        fetch(categoriesUrl)
          .then(r => r.json())
          .then(categories => {
            const filters = document.getElementById('categoryFilters');
            filters.innerHTML = '<button class="active" onclick="selectCategory(null, this)">كل المقالات</button>';
            categories
              .filter(c => c.count > 0 && !c.link.includes('/en/') && c.name !== 'غير مصنف')
              .forEach(c => {
                const btn = document.createElement('button');
                btn.textContent = c.name;
                btn.onclick = () => selectCategory(c.id, btn);
                filters.appendChild(btn);
              });
          });
      }

      function selectCategory(id, btn) {
        selectedCategoryId = id;
        document.querySelectorAll('.posts-filters button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadarticles(true);
      }

      fetch(apiUrl)
        .then(r => r.json())
        .then(isArabicPost)
        .then(posts => {
          showLoader(false);
          showarticlesSection(true);
          showarticles(posts);
        });

      loadCategories();
      loadarticles();
    });
    </script>
  </div>
